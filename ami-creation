# AMI Creation Process - infra_code Repository

## Overview

**Repository:** `infra_code/ami-creation/`  
**Tool:** **Packer** (HashiCorp's AMI creation tool)  
**Purpose:** Create standardized AMIs for EKS (Elastic Kubernetes Service) and EC2 instances

---

## Repository Structure

```
infra_code/ami-creation/
â”œâ”€â”€ build-ami.sh                    # Main build script
â”œâ”€â”€ Makefile                        # Make targets for different environments
â”œâ”€â”€ README.md                       # Quick usage guide
â”œâ”€â”€ Packer.mermaid                  # Visual flow diagram
â”œâ”€â”€ Makefile.mermaid                # Makefile flow diagram
â”‚
â”œâ”€â”€ exotel-integration-eks-usw2.json    # Packer template for Integration EKS
â”œâ”€â”€ exotel-integration-usw2.json         # Packer template for Integration EC2
â”œâ”€â”€ exotel-ireland-eks-euw1.json         # Packer template for Ireland EKS
â”œâ”€â”€ exotel-mum-aps1.json                 # Packer template for Mumbai EC2
â”œâ”€â”€ exotel-mum-eks-aps1.json            # Packer template for Mumbai EKS
â”œâ”€â”€ exotel-sgp-apse1.json               # Packer template for Singapore EC2
â””â”€â”€ exotel-sgp-eks-apse1.json           # Packer template for Singapore EKS
â”‚
â””â”€â”€ scripts/                        # Provisioning scripts
    â”œâ”€â”€ init/                       # Initial setup scripts
    â”‚   â”œâ”€â”€ init.sh                 # Initial system setup
    â”‚   â”œâ”€â”€ setup.sh                # Environment-specific setup
    â”‚   â”œâ”€â”€ set-facts.sh            # Set system facts
    â”‚   â”œâ”€â”€ functions.sh            # Helper functions
    â”‚   â”œâ”€â”€ env/                    # Environment variables
    â”‚   â”‚   â”œâ”€â”€ qa.env
    â”‚   â”‚   â”œâ”€â”€ prod.env
    â”‚   â”‚   â”œâ”€â”€ mum.env
    â”‚   â”‚   â””â”€â”€ ireland.env
    â”‚   â”œâ”€â”€ files/                  # Configuration files
    â”‚   â”‚   â”œâ”€â”€ bashrc
    â”‚   â”‚   â”œâ”€â”€ sshconfig
    â”‚   â”‚   â”œâ”€â”€ sshd_config
    â”‚   â”‚   â”œâ”€â”€ tmux.conf
    â”‚   â”‚   â”œâ”€â”€ vimrc
    â”‚   â”‚   â”œâ”€â”€ awsm                # AWS management tool
    â”‚   â”‚   â””â”€â”€ ross                # ROSS tool
    â”‚   â””â”€â”€ tmpl/                   # Templates
    â”‚       â”œâ”€â”€ aws.config.tpl
    â”‚       â””â”€â”€ resolv.conf.tmpl
    â”‚
    â”œâ”€â”€ management/                 # Management scripts
    â”‚   â”œâ”€â”€ init.sh                 # Management initialization
    â”‚   â”œâ”€â”€ setup.sh                # Management setup
    â”‚   â”œâ”€â”€ packages.sh             # Install packages
    â”‚   â”œâ”€â”€ reloads.sh              # Reload services
    â”‚   â”œâ”€â”€ image-pull.sh           # Pre-pull container images
    â”‚   â”œâ”€â”€ wazuh-installation.sh   # Security monitoring
    â”‚   â””â”€â”€ files/                   # Management files
    â”‚       â”œâ”€â”€ key-sync.service     # SSH key sync service
    â”‚       â”œâ”€â”€ vim-cleanup.service # Vim cleanup service
    â”‚       â”œâ”€â”€ heimdall             # Monitoring tool
    â”‚       â””â”€â”€ configuration        # Config files
    â”‚
    â”œâ”€â”€ cis/                        # CIS (Center for Internet Security) hardening
    â”‚   â”œâ”€â”€ hardening.sh           # Security hardening script
    â”‚   â””â”€â”€ files/                  # CIS configuration files
    â”‚       â”œâ”€â”€ cis-sysctl.conf
    â”‚       â”œâ”€â”€ cis-limits.conf
    â”‚       â”œâ”€â”€ sshd_config
    â”‚       â””â”€â”€ ssh_banner
    â”‚
    â””â”€â”€ tests/                      # Testing scripts
        â””â”€â”€ cis-reporting/
            â””â”€â”€ script.sh
```

---

## How It Works

### 1. **Packer-Based AMI Creation**

**What is Packer?**
- HashiCorp's tool for creating machine images
- Supports multiple platforms (AWS, Azure, GCP, etc.)
- Uses JSON templates to define AMI creation process
- Automates instance launch, configuration, and AMI creation

**Key Difference from Ansible Approach:**
- **Ansible (getafix):** Manual instance creation â†’ Configure â†’ Create AMI
- **Packer (infra_code):** Automated end-to-end process in one command

---

### 2. **Packer Template Structure**

**File:** `exotel-integration-eks-usw2.json`

#### **Variables Section**
```json
{
  "variables": {
    "region": "us-west-2",
    "ami_counter": "{{ env `BUILD_NUMBER` }}",
    "cluster": "{{ env `CLUSTER` }}",
    "vpc_name": "{{ env `VPC_NAME` }}",
    "environment": "{{ env `ENVIRONMENT` }}",
    "subnet_name": "{{ env `SUBNET_NAME` }}",
    "packer_profile": "{{ env `PACKER_ROLE` }}"
  }
}
```

**What this does:**
- Defines variables used throughout the template
- Values come from environment variables or command-line
- `BUILD_NUMBER` is a timestamp (from `build-ami.sh`)

---

#### **Builders Section**
```json
{
  "builders": [{
    "ami_name": "exotel-cpu-ami-{{ user `ami_counter` }}-eks",
    "instance_type": "t2.micro",
    "region": "{{user `region`}}",
    "source_ami_filter": {
      "filters": {
        "name": "amazon-eks-node-al2023-x86_64-standard-1.29-v20251023",
        "virtualization-type": "hvm",
        "root-device-type": "ebs"
      },
      "owners": ["602401143452"],
      "most_recent": true
    },
    "vpc_filter": {
      "filters": {
        "tag:Name": "{{user `vpc_name`}}",
        "tag:env": "{{ user `environment` }}"
      }
    },
    "subnet_filter": {
      "filters": {
        "tag:Name": "{{user `subnet_name`}}"
      },
      "most_free": true
    },
    "encrypt_boot": true,
    "ssh_username": "ec2-user"
  }]
}
```

**What this does:**
- **`ami_name`:** Name of the AMI to create (includes build number)
- **`instance_type`:** EC2 instance type for building (t2.micro - minimal cost)
- **`source_ami_filter`:** Finds the base AMI to start from
  - EKS node AMI: `amazon-eks-node-al2023-x86_64-standard-1.29-v20251023`
  - Owner: `602401143452` (AWS EKS account)
  - Uses most recent matching AMI
- **`vpc_filter`:** Finds VPC by name and environment tag
- **`subnet_filter`:** Finds subnet by name, picks one with most free IPs
- **`encrypt_boot`:** Encrypts the root volume
- **`ssh_username`:** User for SSH access (ec2-user for Amazon Linux)

---

#### **Provisioners Section**
```json
{
  "provisioners": [
    {
      "type": "shell",
      "inline": "cloud-init status --wait"
    },
    {
      "type": "file",
      "source": "./scripts",
      "destination": "/tmp/"
    },
    {
      "type": "shell",
      "inline": "cd /tmp/scripts/init; sudo bash init.sh; sudo bash setup.sh {{ user `environment` }}; sudo bash set-facts.sh;",
      "environment_vars": ["ENVIRONMENT={{user `environment`}}"]
    },
    {
      "type": "shell",
      "inline": "cd /tmp/scripts/management; sudo bash init.sh; sudo bash setup.sh {{ user `environment` }}; sudo bash reloads.sh; sudo bash packages.sh; sudo bash wazuh-installation.sh; sudo bash image-pull.sh",
      "environment_vars": ["ENVIRONMENT={{user `environment`}}"]
    },
    {
      "type": "shell",
      "inline": "sudo rm -rf /tmp/scripts"
    }
  ]
}
```

**What this does:**
1. **Wait for cloud-init:** Ensures instance is fully initialized
2. **Copy scripts:** Uploads all scripts from `./scripts` to `/tmp/scripts` on instance
3. **Run init scripts:**
   - `init.sh` - Initial system setup
   - `setup.sh` - Environment-specific configuration
   - `set-facts.sh` - Set system facts/variables
4. **Run management scripts:**
   - `init.sh` - Management initialization
   - `setup.sh` - Management setup
   - `reloads.sh` - Reload system services
   - `packages.sh` - Install required packages
   - `wazuh-installation.sh` - Install security monitoring
   - `image-pull.sh` - Pre-pull container images (for EKS)
5. **Cleanup:** Removes temporary scripts

---

### 3. **Build Script**

**File:** `build-ami.sh`

**What it does:**
1. Sets `BUILD_NUMBER` to current timestamp
2. Handles debug mode (adds `-debug` flag if `DEBUG` env var is set)
3. Validates required parameters:
   - `-c` Cluster name
   - `-v` VPC name
   - `-e` Environment
   - `-s` Subnet name
   - `-r` IAM role for Packer instance
   - `-t` Packer template file
4. Runs `packer init` to initialize Packer
5. Runs `packer build` with variables

**Example usage:**
```bash
AWS_REGION=us-west-2 ./build-ami.sh \
  -c integration \
  -v vpc_us3-requestor \
  -e qa \
  -s bastion-us3-private-us-west-2b \
  -r qa_ec2_role \
  -t "exotel-integration-eks-usw2.json"
```

---

### 4. **Makefile Targets**

**File:** `Makefile`

**Available targets:**

#### **Installation Targets:**
- `packer` - Checks if Packer is installed, installs if missing
- `awsm` - Copies AWSM and ROSS tools to scripts directory
- `install-packer` - Downloads and installs Packer 1.11.2
- `install-awsm` - Copies AWSM from `../scripts/awsm/`

#### **AMI Creation Targets:**

**EKS AMIs:**
- `mum-eks` - Creates Mumbai EKS AMI
- `sgp-eks` - Creates Singapore EKS AMI
- `integration-eks` - Creates Integration EKS AMI
- `ireland-eks` - Creates Ireland EKS AMI

**EC2 AMIs:**
- `mum` - Creates Mumbai EC2 AMI
- `sgp` - Creates Singapore EC2 AMI
- `integration` - Creates Integration EC2 AMI

**Usage:**
```bash
make mum-eks        # Create Mumbai EKS AMI
make sgp-eks        # Create Singapore EKS AMI
make integration-eks # Create Integration EKS AMI
```

**Note:** These commands must be run on the individual stamp's servers (Mumbai, Singapore, etc.) because they launch EC2 instances in those regions.

---

## Complete AMI Creation Flow

```
1. Run Make Target (e.g., `make integration-eks`)
   â†“
2. Makefile checks for Packer and AWSM
   - If missing, installs them
   â†“
3. Makefile calls build-ami.sh with parameters
   â†“
4. build-ami.sh sets BUILD_NUMBER and validates parameters
   â†“
5. Packer init initializes Packer
   â†“
6. Packer build starts:
   a. Finds base AMI (EKS node AMI)
   b. Finds VPC by name and environment tag
   c. Finds subnet by name
   d. Launches temporary EC2 instance (t2.micro)
   e. Waits for cloud-init
   â†“
7. Provisioning Phase:
   a. Uploads scripts to /tmp/scripts
   b. Runs init scripts (init.sh, setup.sh, set-facts.sh)
   c. Runs management scripts (packages, wazuh, image-pull)
   d. Cleans up /tmp/scripts
   â†“
8. Packer creates AMI from configured instance
   â†“
9. Packer terminates temporary instance
   â†“
10. AMI is ready with name: exotel-cpu-ami-{BUILD_NUMBER}-eks
```

---

## Key Scripts Explained

### **Init Scripts** (`scripts/init/`)

#### **`init.sh`**
- Initial system setup
- Creates directories
- Sets up basic environment

#### **`setup.sh`**
- Environment-specific configuration
- Uses environment files from `env/` directory
- Configures system based on environment (qa, prod, mum, ireland)

#### **`set-facts.sh`**
- Sets system facts/variables
- Configures hostname, domain, etc.

#### **`functions.sh`**
- Helper functions used by other scripts
- Common utilities

---

### **Management Scripts** (`scripts/management/`)

#### **`packages.sh`**
- Installs required system packages
- Updates package lists
- Installs tools needed for EKS/EC2

#### **`reloads.sh`**
- Reloads system services
- Restarts services with new configurations

#### **`wazuh-installation.sh`**
- Installs Wazuh security monitoring agent
- Configures security monitoring

#### **`image-pull.sh`**
- Pre-pulls container images for EKS
- Reduces startup time for pods
- Pulls common base images

---

### **CIS Hardening** (`scripts/cis/`)

#### **`hardening.sh`**
- Applies CIS (Center for Internet Security) benchmarks
- Security hardening configurations
- System security best practices

---

## Environment-Specific Templates

### **EKS Templates:**
- `exotel-integration-eks-usw2.json` - Integration EKS (US West 2)
- `exotel-mum-eks-aps1.json` - Mumbai EKS (AP South 1)
- `exotel-sgp-eks-apse1.json` - Singapore EKS (AP Southeast 1)
- `exotel-ireland-eks-euw1.json` - Ireland EKS (EU West 1)

### **EC2 Templates:**
- `exotel-integration-usw2.json` - Integration EC2 (US West 2)
- `exotel-mum-aps1.json` - Mumbai EC2 (AP South 1)
- `exotel-sgp-apse1.json` - Singapore EC2 (AP Southeast 1)

**Key Differences:**
- **EKS templates:** Start from EKS node AMI, include `image-pull.sh` for container images
- **EC2 templates:** Start from standard Amazon Linux AMI, no container image pre-pull

---

## Required Parameters

### **For build-ami.sh:**
- `-c` **Cluster:** Cluster name (integration, mum, sgp, ireland)
- `-v` **VPC Name:** VPC name to use (e.g., `vpc_us3-requestor`, `vpc-mum`)
- `-e` **Environment:** Environment name (qa, prod, mum, ireland)
- `-s` **Subnet:** Subnet name (e.g., `bastion-us3-private-us-west-2b`)
- `-r` **IAM Role:** IAM role for Packer instance (e.g., `qa_ec2_role`)
- `-t` **Template:** Packer template JSON file

### **Environment Variables:**
- `AWS_REGION` - AWS region (us-west-2, ap-south-1, ap-southeast-1, eu-west-1)
- `DEBUG` - Set to enable debug mode (adds `-debug` flag)

---

## Example: Creating Integration EKS AMI

```bash
# Navigate to ami-creation directory
cd infra_code/ami-creation

# Option 1: Using Makefile
make integration-eks

# Option 2: Using build-ami.sh directly
AWS_REGION=us-west-2 ./build-ami.sh \
  -c integration \
  -v vpc_us3-requestor \
  -e qa \
  -s bastion-us3-private-us-west-2b \
  -r qa_ec2_role \
  -t "exotel-integration-eks-usw2.json"
```

**What happens:**
1. Packer finds base EKS AMI: `amazon-eks-node-al2023-x86_64-standard-1.29-v20251023`
2. Launches t2.micro instance in `vpc_us3-requestor`, subnet `bastion-us3-private-us-west-2b`
3. Runs all provisioning scripts
4. Creates AMI: `exotel-cpu-ami-{timestamp}-eks`
5. Terminates temporary instance

---

## Comparison: Packer vs Ansible Approach

### **Packer (infra_code):**
âœ… **Pros:**
- Fully automated (one command)
- No manual instance management
- Built-in cleanup (terminates instance automatically)
- Standardized process
- Better for CI/CD integration

âŒ **Cons:**
- Requires Packer installation
- Less flexible for complex multi-step processes
- Limited to what Packer supports

### **Ansible (getafix):**
âœ… **Pros:**
- More flexible
- Can do complex multi-phase operations
- Better for existing infrastructure
- Can reuse existing Ansible roles

âŒ **Cons:**
- Manual instance management
- More steps involved
- Requires manual cleanup

---

## Summary

**Repository:** `infra_code/ami-creation/`  
**Tool:** Packer (HashiCorp)  
**Process:**
1. Define Packer template (JSON)
2. Run `make {target}` or `build-ami.sh`
3. Packer launches instance, configures it, creates AMI
4. AMI ready with name: `exotel-cpu-ami-{BUILD_NUMBER}-eks`

**Key Features:**
- Automated end-to-end AMI creation
- Environment-specific templates
- EKS and EC2 support
- Security hardening (CIS)
- Pre-pulls container images for EKS
- Encrypted boot volumes

**Usage:**
```bash
make integration-eks  # Create Integration EKS AMI
make mum-eks         # Create Mumbai EKS AMI
make sgp-eks         # Create Singapore EKS AMI
```

That's the complete AMI creation process in `infra_code`! ğŸš€

